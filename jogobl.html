<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Batalha Naval - Partida</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  background:#020202;
  color:#fff;
  font-family:Arial, sans-serif;
  text-align:center;
  margin:0; padding:20px;
}
h2{margin-bottom:15px;}
#tabuleiro{
  display:grid;
  grid-template-columns:repeat(10,40px);
  grid-template-rows:repeat(10,40px);
  gap:2px;
  justify-content:center;
  margin-bottom:20px;
}
.celula{
  width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:24px;
  background:#111;
  border-radius:4px;
  cursor:pointer;
  transition: transform 0.3s;
}
.celula.revelada{
  transform: rotateY(180deg);
}
button{
  padding:10px 15px;
  border:none;
  border-radius:6px;
  background:#0af;
  font-weight:bold;
  cursor:pointer;
  color:#000;
}
button:disabled{background:#555; cursor:not-allowed;}
.sairBtn{
  position:fixed;
  top:20px;
  right:20px;
  background:#f33;
  color:#fff;
  padding:10px;
}
#mensagem{
  font-size:22px;
  margin-top:15px;
}
</style>
</head>
<body>

<h2>Batalha Naval - Sala</h2>
<button class="sairBtn">Sair da partida</button>
<div id="tabuleiro"></div>
<div id="mensagem"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, get, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxq1jjSig-yW0kmtR1d_WBYCcc7Ysjz00",
  authDomain: "batalha-naval-web-5c204.firebaseapp.com",
  databaseURL: "https://batalha-naval-web-5c204-default-rtdb.firebaseio.com",
  projectId: "batalha-naval-web-5c204"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const params = new URLSearchParams(window.location.search);
const salaId = params.get("sala");
if(!salaId) window.location.href="salas.html";

let usuario;
let turno = null;
let jogadores = [];
let tabuleiro = [];
let meusPontos = 0;
const tabuleiroDiv = document.getElementById("tabuleiro");
const msgDiv = document.getElementById("mensagem");
const sairBtn = document.querySelector(".sairBtn");

// Sons
const audioAgua = new Audio("agua.mp3");
const audioBomba = new Audio("bomba.mp3");
const audioNavio = new Audio("navio.mp3");
const audioTurno = new Audio("turno.mp3");
const audioVitoria = new Audio("vitoria.mp3");

// Inicializa tabuleiro
for(let i=0;i<10;i++){
  tabuleiro[i]=[];
  for(let j=0;j<10;j++){
    const cel = document.createElement("div");
    cel.className="celula";
    cel.textContent="ðŸŒŠ";
    cel.dataset.linha=i;
    cel.dataset.coluna=j;
    tabuleiro[i][j]={cel, navio:false, revelada:false};
    tabuleiroDiv.appendChild(cel);
  }
}

// Coloca 1 navio por linha aleatÃ³rio
function colocarNavios(){
  for(let i=0;i<10;i++){
    const pos = Math.floor(Math.random()*10);
    tabuleiro[i][pos].navio=true;
  }
}
colocarNavios();

// FunÃ§Ã£o de revelar cÃ©lula
async function revelar(i,j){
  if(!turno || turno!==usuario.uid) return;
  const c = tabuleiro[i][j];
  if(c.revelada) return;
  c.revelada=true;
  c.cel.classList.add("revelada");
  if(c.navio){
    c.cel.textContent="ðŸ›³ï¸";
    meusPontos+=3;
    audioNavio.play();
  }else{
    c.cel.textContent="ðŸ’£";
    audioBomba.play();
  }

  // Atualiza ataques no firebase
  await set(ref(db, `salas/${salaId}/ataques/${usuario.uid}/${i}-${j}`), c.navio?3:0);

  // Muda turno
  const proximoUid = jogadores.find(u=>u!==usuario.uid);
  await update(ref(db, `salas/${salaId}`), {vez:proximoUid});
  audioTurno.play();
  checarFim();
}

// Checa fim de partida
async function checarFim(){
  const todas = tabuleiro.flat();
  if(todas.every(c=>c.revelada)){
    let vencedor="";
    let pontosInimigo=0;

    // Busca pontos inimigo
    const snap = await get(ref(db, `salas/${salaId}/ataques`));
    const ataques = snap.val()||{};
    for(const [uid,val] of Object.entries(ataques)){
      if(uid!==usuario.uid){
        pontosInimigo=Object.values(val).reduce((acc,v)=>acc+v,0);
      }
    }

    if(meusPontos>pontosInimigo){
      vencedor=`VitÃ³ria ðŸ†\n${meusPontos} pts`;
      audioVitoria.play();
    }else{
      vencedor=`Derrota â˜ ï¸\n${meusPontos} pts`;
    }

    msgDiv.textContent=vencedor;

    // Atualiza rank do vencedor
    const usuariosRef = ref(db, `usuarios/${usuario.uid}`);
    const snapU = await get(usuariosRef);
    const dadosU = snapU.val();
    await update(usuariosRef,{pontos:(dadosU.pontos||0)+meusPontos});

    // Reseta sala
    setTimeout(()=>{
      remove(ref(db, `salas/${salaId}/ataques`));
      update(ref(db, `salas/${salaId}`), {iniciada:false});
      window.location.href="rank.html";
    },4000);
  }
}

// Sair da partida
sairBtn.onclick=async ()=>{
  if(confirm("Deseja sair da partida?")){
    await remove(ref(db, `salas/${salaId}/players/${usuario.uid}`));
    await remove(ref(db, `salas/${salaId}/ataques/${usuario.uid}`));
    window.location.href="salas.html";
  }
};

// AutenticaÃ§Ã£o e inicializaÃ§Ã£o
onAuthStateChanged(auth,user=>{
  if(!user) window.location.href="login.html";
  usuario=user;
  initJogo();
});

// Inicializa jogo
async function initJogo(){
  const salaRef = ref(db, `salas/${salaId}`);
  const snap = await get(salaRef);
  const dados = snap.val()||{};
  jogadores = Object.keys(dados.players||{});
  if(jogadores.length<2) {
    alert("Esperando outro jogador...");
    return;
  }

  // Marca primeiro jogador como turno
  const primeiro = jogadores[0];
  await update(salaRef,{vez:primeiro});
  audioTurno.play();

  // Observa turno
  onValue(ref(db, `salas/${salaId}/vez`), snap=>{
    turno = snap.val();
  });

  // Observa saÃ­da
  onValue(ref(db, `salas/${salaId}/players`), snap=>{
    const ps = Object.keys(snap.val()||{});
    if(ps.length<2){
      alert("Um jogador saiu. Voltando para salas...");
      window.location.href="salas.html";
    }
  });

  // Adiciona evento de clique nas cÃ©lulas
  for(let i=0;i<10;i++){
    for(let j=0;j<10;j++){
      tabuleiro[i][j].cel.onclick=()=>revelar(i,j);
    }
  }
}
</script>
</body>
</html>
