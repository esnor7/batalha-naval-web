<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Jogo - Batalha Naval</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  background:#020202;
  color:#fff;
  font-family:Arial, sans-serif;
  margin:0;
  padding:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
h2{text-align:center;}
#tabuleiro{
  display:grid;
  grid-template-columns: repeat(10, 35px);
  grid-template-rows: repeat(10, 35px);
  gap:2px;
  margin-top:20px;
}
.celula{
  width:35px;
  height:35px;
  background:#0af;
  display:flex;
  justify-content:center;
  align-items:center;
  cursor:pointer;
  font-size:20px;
  user-select:none;
}
.celula.revelada{background:#111; cursor:default;}
.botaoSair{
  position:fixed;
  top:10px;
  right:10px;
  padding:10px 15px;
  background:#f33;
  border:none;
  border-radius:5px;
  font-weight:bold;
  cursor:pointer;
}
#mensagem{
  margin-top:20px;
  font-size:20px;
  text-align:center;
}
</style>
</head>
<body>

<h2>Jogo - Batalha Naval</h2>
<button class="botaoSair">Sair da Partida</button>
<div id="tabuleiro"></div>
<div id="mensagem"></div>

<audio id="audioAgua" src="agua.mp3"></audio>
<audio id="audioBomba" src="bomba.mp3"></audio>
<audio id="audioNavio" src="navio.mp3"></audio>
<audio id="audioTurno" src="turno.mp3"></audio>
<audio id="audioVitoria" src="vitoria.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, get, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxq1jjSig-yW0kmtR1d_WBYCcc7Ysjz00",
  authDomain: "batalha-naval-web-5c204.firebaseapp.com",
  databaseURL: "https://batalha-naval-web-5c204-default-rtdb.firebaseio.com",
  projectId: "batalha-naval-web-5c204"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const tabuleiroDiv = document.getElementById("tabuleiro");
const mensagemDiv = document.getElementById("mensagem");
const sairBtn = document.querySelector(".botaoSair");

const audioAgua = document.getElementById("audioAgua");
const audioBomba = document.getElementById("audioBomba");
const audioNavio = document.getElementById("audioNavio");
const audioTurno = document.getElementById("audioTurno");
const audioVitoria = document.getElementById("audioVitoria");

let salaId = new URLSearchParams(window.location.search).get("sala");
let usuario;
let tabuleiro = [];
let vezUid = null;
let pontos = 0;

onAuthStateChanged(auth, user => {
  if(!user) return window.location.href="login.html";
  usuario = user;
  inicializarJogo();
});

async function inicializarJogo(){
  const salaRef = ref(db, `salas/${salaId}`);

  // Cria tabuleiro √∫nico se n√£o existir
  const salaSnap = await get(salaRef);
  if(!salaSnap.val().tabuleiro){
    const novoTabuleiro = criarTabuleiro();
    await set(ref(db, `salas/${salaId}/tabuleiro`), novoTabuleiro);
    await set(ref(db, `salas/${salaId}/turno`), usuario.uid);
  }

  // Marca jogador como presente
  await set(ref(db, `salas/${salaId}/players/${usuario.uid}/presente`), true);

  // Atualiza tudo em tempo real
  onValue(salaRef, snap=>{
    const dados = snap.val();

    if(!dados) return;

    // Tabuleiro e turno
    tabuleiro = dados.tabuleiro || [];
    vezUid = dados.turno || null;

    // Pontua√ß√£o
    pontos = dados.players?.[usuario.uid]?.pontos || 0;

    // Atualiza tabuleiro na tela
    renderizarTabuleiro();

    // Mensagem de aguardando jogador
    const jogadoresPresentes = Object.values(dados.players||{}).filter(p=>p.presente);
    if(jogadoresPresentes.length<2){
      mensagemDiv.textContent = "Aguardando outro jogador...";
    } else {
      mensagemDiv.textContent = "Vez de " + (vezUid===usuario.uid ? "voc√™" : "oponente");
    }

    // Verifica fim de jogo
    const todasReveladas = tabuleiro.flat().every(c=>c.revelado);
    if(todasReveladas){
      const [player1, player2] = Object.values(dados.players);
      const pontos1 = player1.pontos || 0;
      const pontos2 = player2.pontos || 0;
      let resultado="";
      if(pontos1>pontos2){
        resultado = (usuario.uid===player1.uid?"Vit√≥ria üèÜ":"Derrota ‚ò†Ô∏è");
      } else if(pontos2>pontos1){
        resultado = (usuario.uid===player2.uid?"Vit√≥ria üèÜ":"Derrota ‚ò†Ô∏è");
      } else {
        resultado = "Empate ‚öñÔ∏è";
      }
      mensagemDiv.textContent = `${resultado}\n${pontos} pts`;
      audioVitoria.play();
      // Atualiza pontua√ß√£o no rank
      Object.keys(dados.players||{}).forEach(async uid=>{
        const userDataRef = ref(db, `usuarios/${uid}`);
        const snapUser = await get(userDataRef);
        const nomeUser = snapUser.val()?.nome || "Jogador";
        const pontosUser = dados.players[uid].pontos || 0;
        const vitorias = dados.players[uid].vitorias || 0;
        await update(userDataRef, {pontos:pontosUser, vitorias:vitorias});
      });
    }
  });

  sairBtn.onclick = async ()=>{
    const salaSnap = await get(salaRef);
    const dados = salaSnap.val();
    if(!dados) return;
    const jogadoresPresentes = Object.entries(dados.players||{}).filter(([uid,p])=>p.presente);
    const nomeUsuario = dados.players?.[usuario.uid]?.nome || "Jogador";
    if(confirm(`${nomeUsuario} deseja sair da partida?`)){
      await remove(ref(db, `salas/${salaId}/players/${usuario.uid}/presente`));
      // Remove do turno se for o da vez
      if(dados.turno===usuario.uid){
        const outroUid = jogadoresPresentes.find(([uid])=>uid!==usuario.uid)?.[0];
        if(outroUid) await update(salaRef,{turno:outroUid});
      }
      window.location.href="salas.html";
    }
  };
}

// Cria tabuleiro 10x10 com 3 navios por linha aleat√≥rios
function criarTabuleiro(){
  const tab = [];
  for(let i=0;i<10;i++){
    const linha = [];
    const posNavios = [];
    while(posNavios.length<3){
      const pos = Math.floor(Math.random()*10);
      if(!posNavios.includes(pos)) posNavios.push(pos);
    }
    for(let j=0;j<10;j++){
      if(posNavios.includes(j)){
        linha.push({conteudo:'üõ≥Ô∏è', revelado:false});
      } else {
        linha.push({conteudo:'üí£', revelado:false});
      }
    }
    tab.push(linha);
  }
  return tab;
}

// Renderiza o tabuleiro na tela
function renderizarTabuleiro(){
  tabuleiroDiv.innerHTML="";
  for(let i=0;i<10;i++){
    for(let j=0;j<10;j++){
      const cel = document.createElement("div");
      cel.className="celula";
      cel.textContent = tabuleiro[i][j].revelado ? tabuleiro[i][j].conteudo : 'üåä';
      if(!tabuleiro[i][j].revelado){
        cel.onclick = ()=> clicarCelula(i,j);
      }
      tabuleiroDiv.appendChild(cel);
    }
  }
}

async function clicarCelula(i,j){
  const salaRef = ref(db, `salas/${salaId}`);
  const salaSnap = await get(salaRef);
  const dados = salaSnap.val();
  if(vezUid!==usuario.uid) return; // s√≥ o da vez

  if(tabuleiro[i][j].revelado) return;

  const cel = tabuleiro[i][j];
  cel.revelado = true;

  // Pontua√ß√£o
  if(cel.conteudo==='üõ≥Ô∏è'){
    pontos +=3;
    audioNavio.play();
  } else {
    audioBomba.play();
  }

  // Alterna turno
  const outrosUids = Object.keys(dados.players||{}).filter(uid=>uid!==usuario.uid);
  if(outrosUids.length>0){
    await update(salaRef,{turno:outrosUids[0]});
    audioTurno.play();
  }

  // Salva tabuleiro e pontos
  await update(salaRef,{tabuleiro});
  await update(ref(db, `salas/${salaId}/players/${usuario.uid}`),{pontos});

  renderizarTabuleiro();
}
</script>

</body>
</html>
