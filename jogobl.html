<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Batalha Naval - Jogo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  background:#020202;
  color:#fff;
  font-family:Arial, sans-serif;
  margin:0;
  padding:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
h2{text-align:center;}
#boards{display:flex; gap:20px; margin-top:20px;}
.board{display:grid; grid-template-columns: repeat(5, 50px); grid-template-rows: repeat(5, 50px);}
.cell{border:1px solid #0af; width:50px; height:50px; display:flex; justify-content:center; align-items:center; cursor:pointer; user-select:none;}
.cell.hit{background:red;}
.cell.miss{background:#333;}
#status{margin-top:20px;}
#sairBtn{position:fixed; top:20px; right:20px; padding:10px 15px; border:none; border-radius:5px; background:#f33; color:#fff; font-weight:bold; cursor:pointer;}
</style>
</head>
<body>

<h2>Batalha Naval - Sala</h2>
<button id="sairBtn">Sair</button>
<div id="boards">
  <div>
    <h3>Seu Tabuleiro</h3>
    <div id="meuBoard" class="board"></div>
  </div>
  <div>
    <h3>Tabuleiro Inimigo</h3>
    <div id="inimigoBoard" class="board"></div>
  </div>
</div>
<div id="status">Aguardando jogador...</div>

<audio id="somAgua" src="agua.mp3"></audio>
<audio id="somBomba" src="bomba.mp3"></audio>
<audio id="somNavio" src="navio.mp3"></audio>
<audio id="somTurno" src="turno.mp3"></audio>
<audio id="somVitoria" src="vitoria.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, get, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxq1jjSig-yW0kmtR1d_WBYCcc7Ysjz00",
  authDomain: "batalha-naval-web-5c204.firebaseapp.com",
  databaseURL: "https://batalha-naval-web-5c204-default-rtdb.firebaseio.com",
  projectId: "batalha-naval-web-5c204"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const urlParams = new URLSearchParams(window.location.search);
const salaId = urlParams.get("sala");

let usuario, meuTabuleiro = [], inimigoTabuleiro = [], meuTurno = false, outroUid;

const meuBoardDiv = document.getElementById("meuBoard");
const inimigoBoardDiv = document.getElementById("inimigoBoard");
const statusDiv = document.getElementById("status");

const somAgua = document.getElementById("somAgua");
const somBomba = document.getElementById("somBomba");
const somNavio = document.getElementById("somNavio");
const somTurno = document.getElementById("somTurno");
const somVitoria = document.getElementById("somVitoria");

onAuthStateChanged(auth, user=>{
  if(!user) return window.location.href="login.html";
  usuario = user;
  inicializarJogo();
});

async function inicializarJogo(){
  const salaRef = ref(db, `salas/${salaId}`);
  const salaSnap = await get(salaRef);
  if(!salaSnap.exists()) return alert("Sala não encontrada!");

  const sala = salaSnap.val();
  const players = Object.keys(sala.players || {});
  outroUid = players.find(uid => uid !== usuario.uid);

  meuTurno = !outroUid;

  // Criar tabuleiros 5x5
  for(let i=0;i<5;i++){
    meuTabuleiro[i] = [];
    inimigoTabuleiro[i] = [];
    for(let j=0;j<5;j++){
      meuTabuleiro[i][j] = 0;
      inimigoTabuleiro[i][j] = 0;

      const cellMeu = document.createElement("div");
      cellMeu.className="cell";
      cellMeu.dataset.row=i;
      cellMeu.dataset.col=j;
      meuBoardDiv.appendChild(cellMeu);

      const cellIni = document.createElement("div");
      cellIni.className="cell";
      cellIni.dataset.row=i;
      cellIni.dataset.col=j;
      inimigoBoardDiv.appendChild(cellIni);

      cellIni.onclick = async ()=>{
        if(!meuTurno) return;
        if(cellIni.classList.contains("hit") || cellIni.classList.contains("miss")) return;

        somAgua.play(); // padrão água
        const cellData = {row:i,col:j,uid:usuario.uid};
        await set(ref(db, `salas/${salaId}/ataques/${i}_${j}`), cellData);
      };
    }
  }

  // Observa ataques
  onValue(ref(db, `salas/${salaId}/ataques`), snap=>{
    const ataques = snap.val() || {};
    for(const key in ataques){
      const {row, col, uid} = ataques[key];
      const meuCell = meuBoardDiv.children[row*5 + col];
      const inimCell = inimigoBoardDiv.children[row*5 + col];

      if(uid === usuario.uid){
        // Seu ataque
        const acerto = Math.random()<0.5; 
        if(acerto){inimCell.classList.add("hit"); somBomba.play(); somNavio.play();}
        else{inimCell.classList.add("miss"); somAgua.play();}
        meuTurno = false;
        statusDiv.textContent="Vez do outro jogador...";
        somTurno.play();
      } else {
        // Ataque do outro
        const acerto = Math.random()<0.5;
        if(acerto){meuCell.classList.add("hit"); somBomba.play(); somNavio.play();}
        else{meuCell.classList.add("miss"); somAgua.play();}
        meuTurno = true;
        statusDiv.textContent="Sua vez!";
        somTurno.play();
      }
    }
  });

  // Observa se alguém saiu
  onValue(ref(db, `salas/${salaId}/players`), snap=>{
    const playersNow = Object.entries(snap.val() || {});
    if(playersNow.length < 2){
      if(playersNow.length===0 || !playersNow.find(p=>p[0]===usuario.uid)){
        alert("Alguém abandonou o jogo! Voltando para salas.");
        window.location.href="salas.html";
      } else {
        statusDiv.textContent="Aguardando o outro jogador...";
      }
    }
  });
}

// Botão sair
document.getElementById("sairBtn").onclick = async ()=>{
  if(confirm("Deseja sair da partida?")){
    await remove(ref(db, `salas/${salaId}/players/${usuario.uid}`));
    window.location.href="salas.html";
  }
};
</script>
</body>
</html>
