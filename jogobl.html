<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Batalha Naval - Partida</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  background:#020202;
  color:#fff;
  font-family:Arial, sans-serif;
  margin:0;
  padding:10px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.topo {
  width:100%;
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
  font-size:14px;
}
.turno {
  font-weight:bold;
  color:#0af;
  margin-bottom:10px;
}
.tabuleiro {
  display:grid;
  grid-template-columns:repeat(10, 1fr);
  gap:4px;
  max-width:95vw;
}
.casa {
  aspect-ratio:1/1;
  background:#0af;
  border-radius:5px;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:1.4rem;
  cursor:pointer;
  transition: transform 0.2s;
}
.casa:hover { transform: scale(1.1); }
.casa.revelada {
  background:#111;
  cursor:default;
}
#popupPontuacao {
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  font-size:2rem;
  background:rgba(0,0,0,0.7);
  padding:20px;
  border-radius:10px;
  display:none;
  z-index:10;
  text-align:center;
}
#botaoSair {
  position:fixed;
  bottom:20px;
  right:20px;
  padding:12px 20px;
  background:#f33;
  color:#fff;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>
<body>

<div class="topo">
  <div id="p1">Player 1</div>
  <div class="turno" id="turno">Carregando...</div>
  <div id="p2">Player 2</div>
</div>

<div class="tabuleiro" id="tabuleiro"></div>

<div id="popupPontuacao"></div>
<button id="botaoSair">Sair da Partida</button>

<audio id="somAgua" src="agua.mp3"></audio>
<audio id="somBomba" src="bomba.mp3"></audio>
<audio id="somNavio" src="navio.mp3"></audio>
<audio id="somTurno" src="turno.mp3"></audio>
<audio id="somVitoria" src="vitoria.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, get, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxq1jjSig-yW0kmtR1d_WBYCcc7Ysjz00",
  authDomain: "batalha-naval-web-5c204.firebaseapp.com",
  databaseURL: "https://batalha-naval-web-5c204-default-rtdb.firebaseio.com",
  projectId: "batalha-naval-web-5c204"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const tabuleiroDiv = document.getElementById("tabuleiro");
const turnoEl = document.getElementById("turno");
const popupPontuacao = document.getElementById("popupPontuacao");
const p1El = document.getElementById("p1");
const p2El = document.getElementById("p2");
const botaoSair = document.getElementById("botaoSair");

const somAgua = document.getElementById("somAgua");
const somBomba = document.getElementById("somBomba");
const somNavio = document.getElementById("somNavio");
const somTurno = document.getElementById("somTurno");
const somVitoria = document.getElementById("somVitoria");

const params = new URLSearchParams(window.location.search);
const salaId = params.get("sala");
if(!salaId){ alert("Sala inv√°lida"); window.location.href="salas.html"; }

let usuario, tabuleiro=[], minhaVez=false, pontos=0;

let somAtual=null;

onAuthStateChanged(auth, user=>{
  if(!user) return window.location.href="login.html";
  usuario = user;
  iniciarSala();
});

async function iniciarSala(){
  const salaRef = ref(db, `salas/${salaId}`);

  const snap = await get(salaRef);
  const sala = snap.val();

  if(!sala.tabuleiro){
    await set(ref(db, `salas/${salaId}/tabuleiro`), gerarTabuleiro());
  }

  // Inicializa pontos
  if(!sala.pontos) await set(ref(db, `salas/${salaId}/pontos/${usuario.uid}`), 0);

  onValue(salaRef, snap=>{
    const dados = snap.val();
    if(!dados) return;

    const players = Object.entries(dados.players || {});
    p1El.textContent = "Player 1: " + (players[0]?.[1]?.nome || "...");
    p2El.textContent = "Player 2: " + (players[1]?.[1]?.nome || "...");

    minhaVez = dados.turno === usuario.uid;
    turnoEl.textContent = minhaVez ? "üî• Sua vez" : "‚è≥ Vez do advers√°rio";

    tabuleiro = dados.tabuleiro;
    pontos = dados.pontos?.[usuario.uid] || 0;

    renderizarTabuleiro();

    // Checa vit√≥ria
    const navios = tabuleiro.flat().filter(c=>c.tipo==="navio");
    const revelados = navios.filter(c=>c.revelado);
    if(revelados.length === navios.length && navios.length>0){
      somVitoria.play();
      const jogadoresPontos = dados.pontos || {};
      const vencedor = Object.entries(jogadoresPontos).sort((a,b)=>b[1]-a[1])[0];
      const mensagem = vencedor[0]===usuario.uid ? `üèÜ Vit√≥ria!\n${pontos} pts` : `‚ò†Ô∏è Derrota\n${pontos} pts`;
      alert(mensagem);

      // Atualiza rank
      update(ref(db, `usuarios/${usuario.uid}`), { pontos: pontos, vitorias: vencedor[0]===usuario.uid ? 1 : 0 });
    }
  });
}

function gerarTabuleiro(){
  const grid = [];
  for(let i=0;i<10;i++){
    const linha=[];
    let navioCols = [];
    while(navioCols.length<3){
      const col = Math.floor(Math.random()*10);
      if(!navioCols.includes(col)) navioCols.push(col);
    }
    for(let j=0;j<10;j++){
      linha.push({tipo: navioCols.includes(j)?"navio":"bomba", revelado:false});
    }
    grid.push(linha);
  }
  return grid;
}

function renderizarTabuleiro(){
  tabuleiroDiv.innerHTML="";
  tabuleiro.forEach((linha,i)=>{
    linha.forEach((casa,j)=>{
      const div=document.createElement("div");
      div.className="casa";
      if(casa.revelado){
        div.classList.add("revelada");
        div.textContent = casa.tipo==="navio"?"üõ≥Ô∏è":"üí£";
      }else div.textContent="üåä";

      if(!minhaVez || casa.revelado) div.classList.add("bloqueada");
      div.onclick = ()=>clicarCasa(i,j);
      tabuleiroDiv.appendChild(div);
    });
  });
}

async function clicarCasa(i,j){
  if(!minhaVez) return;
  const casa = tabuleiro[i][j];
  if(casa.revelado) return;

  casa.revelado = true;
  await set(ref(db, `salas/${salaId}/tabuleiro/${i}/${j}`), casa);

  if(casa.tipo==="navio"){
    pontos+=3;
    await set(ref(db, `salas/${salaId}/pontos/${usuario.uid}`), pontos);
    mostrarPopup("+3");
    tocarSom(somNavio);
  }else{
    tocarSom(somBomba);
  }

  // Troca turno
  const playersSnap = await get(ref(db, `salas/${salaId}/players`));
  const players = Object.keys(playersSnap.val()||{});
  const proximo = players.find(uid=>uid!==usuario.uid);
  await set(ref(db, `salas/${salaId}/turno`), proximo);
}

function mostrarPopup(texto){
  popupPontuacao.textContent = texto;
  popupPontuacao.style.display = "block";
  setTimeout(()=>popupPontuacao.style.display="none",600);
}

function tocarSom(som){
  if(somAtual){ somAtual.pause(); somAtual.currentTime=0; }
  somAtual=som;
  som.play();
}

// Bot√£o sair da partida
botaoSair.onclick = async ()=>{
  if(confirm("Deseja realmente sair da partida?")){
    await remove(ref(db, `salas/${salaId}/players/${usuario.uid}`));
    await remove(ref(db, `salas/${salaId}/ready/${usuario.uid}`));
    window.location.href = "salas.html";
  }
};
</script>
</body>
</html>
