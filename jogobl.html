<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Batalha Naval - Sala</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  background:#020202;
  color:#fff;
  font-family:Arial,sans-serif;
  margin:0;
  padding:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
h2{text-align:center;}
#tabuleiro{
  display:grid;
  grid-template-columns: repeat(10, 35px);
  grid-template-rows: repeat(10, 35px);
  gap:2px;
  margin-top:20px;
}
.casa{
  width:35px;
  height:35px;
  background:#0af;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-size:20px;
  border-radius:4px;
  user-select:none;
}
.casa.virada{
  background:#111;
  cursor:default;
}
#info{
  margin-top:15px;
}
#sairBtn{
  position:fixed;
  top:20px;
  right:20px;
  padding:10px 15px;
  background:#f33;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>
<body>

<h2>Batalha Naval</h2>
<div id="info">Aguardando jogador...</div>
<div id="tabuleiro"></div>
<button id="sairBtn">Sair da Partida</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, onValue, set, update, get, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// Sons
const somAgua = new Audio("agua.mp3");
const somBomba = new Audio("bomba.mp3");
const somNavio = new Audio("navio.mp3");
const somTurno = new Audio("turno.mp3");
const somVitoria = new Audio("vitoria.mp3");

const firebaseConfig = {
  apiKey: "AIzaSyBxq1jjSig-yW0kmtR1d_WBYCcc7Ysjz00",
  authDomain: "batalha-naval-web-5c204.firebaseapp.com",
  databaseURL: "https://batalha-naval-web-5c204-default-rtdb.firebaseio.com",
  projectId: "batalha-naval-web-5c204"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const tabuleiroDiv = document.getElementById("tabuleiro");
const infoDiv = document.getElementById("info");
const sairBtn = document.getElementById("sairBtn");

let usuario, nomeUsuario, salaId, salaRef, tabuleiro = [], vez = null, pontos = 0;

function gerarTabuleiro(){
  // Limpa
  tabuleiroDiv.innerHTML="";
  tabuleiro = [];

  for(let i=0;i<10;i++){
    const linha=[];
    for(let j=0;j<10;j++){
      const casa = document.createElement("div");
      casa.className="casa";
      casa.dataset.linha=i;
      casa.dataset.coluna=j;
      casa.textContent="üåä";
      tabuleiroDiv.appendChild(casa);
      linha.push({navios:[], clicado:false, el:casa});
    }
    tabuleiro.push(linha);
  }

  // Coloca 3 navios por linha
  for(let i=0;i<10;i++){
    let naviosCol=[];
    while(naviosCol.length<3){
      let col=Math.floor(Math.random()*10);
      if(!naviosCol.includes(col)){
        naviosCol.push(col);
        tabuleiro[i][col].navios.push("üõ≥Ô∏è");
      }
    }
  }
}

function atualizarTabuleiro(dados){
  for(let i=0;i<10;i++){
    for(let j=0;j<10;j++){
      const c = tabuleiro[i][j];
      const estado = dados.tabuleiro?.[i]?.[j];
      if(estado?.clicado && !c.clicado){
        c.clicado=true;
        c.el.classList.add("virada");
        if(estado.navios?.length>0){
          c.el.textContent="üõ≥Ô∏è";
          somNavio.play();
        } else {
          c.el.textContent="üí£";
          somBomba.play();
        }
      }
    }
  }
}

function calcularVencedor(dados){
  const players = Object.entries(dados.players || {});
  if(players.length<2) return null;
  const p1 = players[0][1].pontos||0;
  const p2 = players[1][1].pontos||0;
  if(p1===p2) return "Empate";
  return p1>p2 ? players[0][1].nome : players[1][1].nome;
}

function atualizarInfo(dados){
  const players = Object.values(dados.players||{});
  if(players.length<2){
    infoDiv.textContent="Aguardando outro jogador...";
    return;
  }
  infoDiv.textContent=`Vez de: ${dados.vezNome || ""} | Pontos: ${pontos}`;
}

function enviarClique(linha,coluna){
  if(vez!==usuario.uid) return;
  const c = tabuleiro[linha][coluna];
  if(c.clicado) return;

  set(ref(db, `salas/${salaId}/tabuleiro/${linha}/${coluna}`), {
    navios: c.navios,
    clicado:true
  });

  // Atualiza pontos
  let ganho = c.navios.length*3;
  pontos+=ganho;
  update(ref(db, `salas/${salaId}/players/${usuario.uid}`), {pontos});

  // Troca vez
  get(ref(db, `salas/${salaId}/players`)).then(snap=>{
    const uids = Object.keys(snap.val()||{});
    const proximo = uids.find(u=>u!==usuario.uid);
    update(ref(db, `salas/${salaId}`), {vez:proximo, vezNome:snap.val()[proximo].nome});
    somTurno.play();
  });
}

onAuthStateChanged(auth, async user=>{
  if(!user) return window.location.href="login.html";
  usuario = user;
  const nomeSnap = await get(ref(db, `usuarios/${usuario.uid}/nome`));
  nomeUsuario = nomeSnap.val() || "Jogador";

  // Pega sala do query
  const params = new URLSearchParams(window.location.search);
  salaId = params.get("sala");
  salaRef = ref(db, `salas/${salaId}`);
  
  // Inicializa sala se n√£o tiver tabuleiro
  const snap = await get(salaRef);
  if(!snap.val().tabuleiro) gerarTabuleiro();
  else atualizarTabuleiro(snap.val());

  // Coloca jogador na sala se n√£o estiver
  if(!snap.val().players?.[usuario.uid]){
    update(salaRef, {["players/"+usuario.uid]:{nome:nomeUsuario,pontos:0}});
  }

  onValue(salaRef, snap=>{
    const dados = snap.val();
    atualizarTabuleiro(dados);
    atualizarInfo(dados);
    vez = dados.vez || Object.keys(dados.players||{})[0];

    // Verifica fim
    const todas = tabuleiro.flat().every(c=>c.clicado);
    if(todas){
      const vencedor = calcularVencedor(dados);
      if(vencedor){
        alert(vencedor==="Empate"?"Empate!":"Vit√≥ria de "+vencedor);
        somVitoria.play();

        // Atualiza rank
        Object.entries(dados.players||{}).forEach(([uid,p])=>{
          get(ref(db, `usuarios/${uid}`)).then(snap=>{
            const u = snap.val();
            update(ref(db, `usuarios/${uid}`), {pontos:(u.pontos||0)+p.pontos, vitorias:(u.vitorias||0)+(p.nome===vencedor?1:0)});
          });
        });

        // Limpa sala
        update(salaRef,{iniciada:false, tabuleiro:null, players:{}, ready:{}, vez:null, vezNome:null});
        window.location.href="salas.html";
      }
    }
  });

  // Clique nas casas
  tabuleiroDiv.addEventListener("click", e=>{
    if(!e.target.classList.contains("casa")) return;
    const l=parseInt(e.target.dataset.linha);
    const c=parseInt(e.target.dataset.coluna);
    enviarClique(l,c);
  });

  sairBtn.onclick = ()=>{
    if(confirm("Deseja sair da partida?")){
      remove(ref(db, `salas/${salaId}/players/${usuario.uid}`));
      remove(ref(db, `salas/${salaId}/ready/${usuario.uid}`));
      window.location.href="salas.html";
    }
  };
});
</script>

</body>
</html>
