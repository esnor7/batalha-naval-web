<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Batalha Naval - Jogo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  background:#020202;
  color:#fff;
  font-family:Arial, sans-serif;
  margin:0;
  padding:20px;
  display:flex;
  flex-direction:column;
  align-items:center;
}
h2{text-align:center;}
#tabuleiro{
  display:grid;
  grid-template-columns: repeat(10, 40px);
  grid-template-rows: repeat(10, 40px);
  gap:3px;
  margin-top:20px;
}
.casa{
  width:40px;
  height:40px;
  background:#0af;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:24px;
  cursor:pointer;
  user-select:none;
  transition: transform 0.2s;
}
.casa.revelada{transform:rotateY(180deg);}
#info{margin-top:15px;}
#sairPartida{
  position:fixed;
  top:20px;
  right:20px;
  padding:10px 15px;
  background:#f33;
  border:none;
  border-radius:5px;
  font-weight:bold;
  cursor:pointer;
}
</style>
</head>
<body>

<h2>Tabuleiro - Sala <span id="salaId"></span></h2>
<div id="tabuleiro"></div>
<div id="info"></div>
<button id="sairPartida">Sair da partida</button>

<audio id="agua" src="agua.mp3"></audio>
<audio id="bomba" src="bomba.mp3"></audio>
<audio id="navio" src="navio.mp3"></audio>
<audio id="turno" src="turno.mp3"></audio>
<audio id="vitoria" src="vitoria.mp3"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, get, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxq1jjSig-yW0kmtR1d_WBYCcc7Ysjz00",
  authDomain: "batalha-naval-web-5c204.firebaseapp.com",
  databaseURL: "https://batalha-naval-web-5c204-default-rtdb.firebaseio.com",
  projectId: "batalha-naval-web-5c204"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const urlParams = new URLSearchParams(window.location.search);
const salaId = urlParams.get('sala');
document.getElementById("salaId").textContent = salaId;

const tabuleiroDiv = document.getElementById("tabuleiro");
const infoDiv = document.getElementById("info");
const sairBtn = document.getElementById("sairPartida");

let usuario, turnoAtual = null, tabuleiro = [], pontos = 0;

// Sons
const audio = {
  agua: document.getElementById("agua"),
  bomba: document.getElementById("bomba"),
  navio: document.getElementById("navio"),
  turno: document.getElementById("turno"),
  vitoria: document.getElementById("vitoria")
};

onAuthStateChanged(auth, user=>{
  if(!user) return window.location.href="login.html";
  usuario = user;
  iniciarJogo();
});

async function iniciarJogo(){
  const salaRef = ref(db, `salas/${salaId}`);

  // Cria tabuleiro inicial se n√£o existir
  const salaSnap = await get(salaRef);
  if(!salaSnap.val().tabuleiro){
    const novoTabuleiro = [];
    for(let r=0;r<10;r++){
      const linha=[];
      // 3 navios por linha
      let naviosLinha = [];
      while(naviosLinha.length<3){
        let pos = Math.floor(Math.random()*10);
        if(!naviosLinha.includes(pos)) naviosLinha.push(pos);
      }
      for(let c=0;c<10;c++){
        linha.push(naviosLinha.includes(c)?'üõ≥Ô∏è':'üåä');
      }
      novoTabuleiro.push(linha);
    }
    await update(salaRef,{tabuleiro:novoTabuleiro, vez:usuario.uid, pontos:{}, finalizada:false});
  }

  // Cria visual do tabuleiro
  criarVisual();

  // Atualiza tabuleiro em tempo real
  onValue(salaRef, snap=>{
    const dados = snap.val();
    if(!dados) return;
    tabuleiro = dados.tabuleiro;
    turnoAtual = dados.vez;
    const finalizada = dados.finalizada;
    const pontosGlobais = dados.pontos || {};

    // Atualiza casas
    for(let r=0;r<10;r++){
      for(let c=0;c<10;c++){
        const cellDiv = document.getElementById(`c-${r}-${c}`);
        const valor = tabuleiro[r][c];
        if(cellDiv.textContent !== valor && valor!=='üåä'){
          cellDiv.textContent = valor==='üõ≥Ô∏è'?'üí£':valor;
          cellDiv.classList.add("revelada");
          if(valor==='üõ≥Ô∏è') audio.navio.play();
          if(valor==='üåä') audio.agua.play();
        }
      }
    }

    infoDiv.textContent = (turnoAtual===usuario.uid?'Sua vez!':'Vez do advers√°rio') + 
      ` | Seus pontos: ${pontosGlobais[usuario.uid]||0}`;

    if(finalizada){
      let vencedor = Object.entries(pontosGlobais).sort((a,b)=>b[1]-a[1])[0];
      if(vencedor[0]===usuario.uid){
        infoDiv.innerHTML = `Vit√≥ria üèÜ<br>${vencedor[1]} pts`;
        audio.vitoria.play();
      } else {
        infoDiv.innerHTML = `Derrota ‚ò†Ô∏è<br>${vencedor[1]} pts`;
      }
    }
  });
}

// Cria visual do tabuleiro
function criarVisual(){
  tabuleiroDiv.innerHTML='';
  for(let r=0;r<10;r++){
    for(let c=0;c<10;c++){
      const div = document.createElement("div");
      div.id = `c-${r}-${c}`;
      div.className = "casa";
      div.textContent='üåä';
      div.onclick = ()=>clicar(r,c);
      tabuleiroDiv.appendChild(div);
    }
  }
}

// Clicar em uma casa
async function clicar(r,c){
  const salaRef = ref(db, `salas/${salaId}`);
  const salaSnap = await get(salaRef);
  const dados = salaSnap.val();
  if(!dados || dados.finalizada) return;

  if(turnoAtual !== usuario.uid) return;
  const tab = dados.tabuleiro;
  if(tab[r][c]==='üí£' || tab[r][c]==='üåä') return;

  let valorOriginal = tab[r][c];
  tab[r][c] = valorOriginal==='üõ≥Ô∏è'?'üí£':'üåä';

  // Atualiza pontos
  const pts = dados.pontos || {};
  pts[usuario.uid] = (pts[usuario.uid]||0) + (valorOriginal==='üõ≥Ô∏è'?3:0);

  // Troca de turno
  const outrosUids = Object.keys(dados.players || {}).filter(uid=>uid!==usuario.uid);
  const proximo = outrosUids[0] || usuario.uid;

  await update(salaRef,{tabuleiro:tab, vez:proximo, pontos:pts});

  // Checa final de jogo
  const todasReveladas = tab.flat().every(v=>v==='üí£'||v==='üåä');
  if(todasReveladas){
    await update(salaRef,{finalizada:true});
    // Atualiza rank
    for(const uid in pts){
      const userRef = ref(db, `usuarios/${uid}`);
      const userSnap = await get(userRef);
      const userDados = userSnap.val() || {};
      await update(userRef,{pontos:(userDados.pontos||0)+pts[uid], vitorias:(userDados.vitorias||0)+((pts[uid]>=Math.max(...Object.values(pts)))?1:0)});
    }
  }
}

// Sair da partida
sairBtn.onclick = async ()=>{
  const salaRef = ref(db, `salas/${salaId}`);
  const salaSnap = await get(salaRef);
  const dados = salaSnap.val();
  if(!dados) return;
  const outrosUids = Object.keys(dados.players || {}).filter(uid=>uid!==usuario.uid);
  if(outrosUids.length>0){
    if(!confirm("Voc√™ deseja sair da partida? O outro jogador ser√° notificado.")) return;
  }
  await remove(ref(db, `salas/${salaId}/players/${usuario.uid}`));
  await remove(ref(db, `salas/${salaId}/ready/${usuario.uid}`));
  window.location.href = "salas.html";
};
</script>
</body>
</html>
