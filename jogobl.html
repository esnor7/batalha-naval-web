<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Batalha Naval</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { background:#020202; color:#fff; font-family:Arial,sans-serif; display:flex; flex-direction:column; align-items:center; margin:0; padding:10px; }
h2 { margin:10px 0; text-align:center; }
#info { margin-bottom:10px; text-align:center; font-size:16px; }
#tabuleiro { display:grid; grid-template-columns: repeat(10, 1fr); grid-gap:4px; width:100%; max-width:400px; }
.celula { background:#0af; display:flex; justify-content:center; align-items:center; font-size:1.4em; cursor:pointer; border-radius:4px; user-select:none; aspect-ratio:1/1; }
.celula.desativada { cursor:not-allowed; opacity:0.6; }
button { margin-top:10px; padding:10px 20px; border:none; border-radius:6px; background:#f33; color:#fff; font-weight:bold; cursor:pointer; }
</style>
</head>
<body>

<h2>Batalha Naval</h2>
<div id="info">Aguardando jogador...</div>
<div id="tabuleiro"></div>
<button id="sairBtn">Sair da partida</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getDatabase, ref, set, get, update, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBxq1jjSig-yW0kmtR1d_WBYCcc7Ysjz00",
  authDomain: "batalha-naval-web-5c204.firebaseapp.com",
  databaseURL: "https://batalha-naval-web-5c204-default-rtdb.firebaseio.com",
  projectId: "batalha-naval-web-5c204"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const urlParams = new URLSearchParams(window.location.search);
const salaId = urlParams.get("sala");

let usuario, meuUid;
let player1Uid, player2Uid;
let player1Nome, player2Nome;
let vezUid;

// Sons
const audioAgua = new Audio('agua.mp3');
const audioBomba = new Audio('bomba.mp3');
const audioNavio = new Audio('navio.mp3');
const audioTurno = new Audio('turno.mp3');
const audioVitoria = new Audio('vitoria.mp3');

const infoDiv = document.getElementById("info");
const tabuleiroDiv = document.getElementById("tabuleiro");
const sairBtn = document.getElementById("sairBtn");

onAuthStateChanged(auth, user => {
  if(!user) return window.location.href="login.html";
  usuario = user;
  meuUid = user.uid;
  iniciarJogo();
});

async function iniciarJogo(){
  const salaRef = ref(db, `salas/${salaId}`);
  const salaSnap = await get(salaRef);
  const sala = salaSnap.val() || {players:{},ready:{},iniciada:false};

  const uids = Object.keys(sala.players || {});
  player1Uid = uids[0];
  player2Uid = uids[1];

  const tabRef = ref(db, `jogos/${salaId}/tabuleiro`);
  const tabSnap = await get(tabRef);
  if(!tabSnap.exists()){
    const tab = criarTabuleiro();
    await set(tabRef, tab);
    await set(ref(db, `jogos/${salaId}/vez`), player1Uid);
    if(player1Uid) await set(ref(db, `jogos/${salaId}/pontos/${player1Uid}`), 0);
    if(player2Uid) await set(ref(db, `jogos/${salaId}/pontos/${player2Uid}`), 0);
  }

  onValue(ref(db, `jogos/${salaId}/vez`), snap=>{
    vezUid = snap.val();
    atualizarInfo();
  });

  onValue(tabRef, snap=>{
    const tab = snap.val();
    if(tab) renderTabuleiro(tab);
  });

  onValue(ref(db, `salas/${salaId}/players`), snap=>{
    const players = snap.val() || {};
    const uids = Object.keys(players);
    player1Uid = uids[0];
    player2Uid = uids[1];
    player1Nome = players[player1Uid]?.nome || "Aguardando jogador";
    player2Nome = players[player2Uid]?.nome || "...";
    atualizarInfo();
  });
}

function criarTabuleiro(){
  const tab = {};
  for(let i=0;i<10;i++){
    tab[i] = {};
    let posicoesNavio = [];
    while(posicoesNavio.length<3){
      const pos = Math.floor(Math.random()*10);
      if(!posicoesNavio.includes(pos)) posicoesNavio.push(pos);
    }
    for(let j=0;j<10;j++){
      tab[i][j] = posicoesNavio.includes(j) ? "üõ≥Ô∏è" : "üåä";
    }
  }
  return tab;
}

function renderTabuleiro(tab){
  tabuleiroDiv.innerHTML="";
  for(let i=0;i<10;i++){
    for(let j=0;j<10;j++){
      const cel = document.createElement("div");
      cel.className="celula";
      // mostra √°gua inicialmente, navio permanece oculto at√© clicado
      cel.textContent = (tab[i][j]==="üåä" || tab[i][j]==="üõ≥Ô∏è") ? "üåä" : tab[i][j];
      if(meuUid!==vezUid || tab[i][j]==="üí£") cel.classList.add("desativada");
      cel.onclick = ()=>clicarCelula(i,j,tab);
      tabuleiroDiv.appendChild(cel);
    }
  }
}

async function clicarCelula(i,j,tab){
  if(meuUid!==vezUid) return;
  const tabRef = ref(db, `jogos/${salaId}/tabuleiro`);
  const valor = tab[i][j];
  if(valor==="üí£" || valor==="‚ò†Ô∏è") return;

  if(valor==="üåä"){
    tab[i][j]="üí£";
    audioBomba.play();
  } else if(valor==="üõ≥Ô∏è"){
    tab[i][j]="üõ≥Ô∏è"; // mostra navio corretamente
    audioNavio.play();
    const pontosRef = ref(db, `jogos/${salaId}/pontos/${meuUid}`);
    const snap = await get(pontosRef);
    await set(pontosRef, (snap.val()||0)+3);
  }

  await set(tabRef, tab);

  const proximo = (vezUid===player1Uid?player2Uid:player1Uid);
  await set(ref(db, `jogos/${salaId}/vez`), proximo);
  audioTurno.play();

  if(fimDeJogo(tab)){
    await finalizarPartida(tab);
  }
}

function fimDeJogo(tab){
  for(let i=0;i<10;i++){
    for(let j=0;j<10;j++){
      if(tab[i][j]==="üõ≥Ô∏è") return false;
    }
  }
  return true;
}

async function finalizarPartida(tab){
  const pontosSnap = await get(ref(db, `jogos/${salaId}/pontos`));
  const pts = pontosSnap.val() || {};
  const pontos1 = pts[player1Uid]||0;
  const pontos2 = pts[player2Uid]||0;

  let mensagem="";
  if(pontos1>pontos2){
    mensagem = meuUid===player1Uid ? `Vit√≥ria üèÜ\n  (${pontos1} pts)` : `Derrota ‚ò†Ô∏è\n  (${pontos2} pts)`;
  } else if(pontos2>pontos1){
    mensagem = meuUid===player2Uid ? `Vit√≥ria üèÜ\n  (${pontos2} pts)` : `Derrota ‚ò†Ô∏è\n  (${pontos1} pts)`;
  } else {
    mensagem = `Empate ‚öñÔ∏è\n  (${pontos1} pts)`;
  }
  audioVitoria.play();
  alert(mensagem);

  await atualizarRank(player1Uid, pontos1);
  await atualizarRank(player2Uid, pontos2);

  await set(ref(db, `salas/${salaId}/iniciada`), false);
  await remove(ref(db, `jogos/${salaId}`));

  iniciarJogo();
}

async function atualizarRank(uid, pontosPartida){
  const userRef = ref(db, `usuarios/${uid}`);
  const snap = await get(userRef);
  const user = snap.val() || {pontos:0,vitorias:0};
  const novosPontos = (user.pontos||0)+pontosPartida;
  await update(userRef,{pontos:novosPontos, vitorias:(user.vitorias||0)+1});
}

function atualizarInfo(){
  if(!player1Nome) player1Nome="Aguardando jogador";
  if(!player2Nome) player2Nome="...";
  const vezNome = (vezUid===player1Uid?player1Nome:player2Nome);
  infoDiv.textContent = `${player1Nome} vs ${player2Nome} | Vez de ${vezNome}`;
}

// Sair da partida
sairBtn.onclick = async ()=>{
  await remove(ref(db, `salas/${salaId}/players/${meuUid}`));
  await set(ref(db, `salas/${salaId}/iniciada`), false);
  await remove(ref(db, `jogos/${salaId}`));
  window.location.href="salas.html";
};
</script>

</body>
</html>
